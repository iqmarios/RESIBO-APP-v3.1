<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resibo App v3.6.1 ‚Äî Visual Overlay + Tiny Print OCR</title>

  <link rel="manifest" href="manifest.json?v=3.6.1" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="style.css?v=3.6.1" />

  <!-- Core libs -->
  <script defer src="libs/jszip.min.js"></script>
  <script defer src="libs/FileSaver.min.js"></script>
  <script defer src="libs/pdf.min.js"></script>
  <script>
    // Use worker if present; fall back to single-thread mode if not.
    window.addEventListener('load', async () => {
      if (window.pdfjsLib) {
        try {
          const head = await fetch('libs/pdf.worker.min.js', { method:'HEAD' });
          if (head && head.ok) pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';
          else pdfjsLib.disableWorker = true;
        } catch { pdfjsLib.disableWorker = true; }
      }
    });
  </script>
  <script defer src="libs/tesseract.min.js"></script>
  <script defer src="libs/opencv.js"></script>
  <script defer src="app.js?v=3.6.1"></script>
</head>
<body>
<header class="top">
  <h1>Resibo App <span class="chip">v3.6.1</span></h1>
  <nav class="floating">
    <button id="btn-top" class="fab">üè† Top</button>
    <button id="btn-jump-step3" class="fab">‚¨á Review</button>
  </nav>
</header>

<main class="wrap">

  <!-- SETTINGS -->
  <section class="card">
    <h2>Settings</h2>
    <div class="row">
      <label>Issued Codes CSV URL (HTTPS)</label>
      <input id="csvUrl" placeholder="https://docs.google.com/.../pub?output=csv" />
    </div>
    <div class="row">
      <button id="btn-save-settings" class="btn">Save</button>
      <button id="btn-test-csv" class="btn">Test CSV</button>
      <span id="csv-status" class="pill">No URL</span>
    </div>
  </section>

  <!-- STEP 1 -->
  <section class="card" id="step1">
    <h2>Step 1 ‚Äî Access Verification</h2>
    <div class="grid2">
      <div><label>Access Code</label><input id="acc_code"></div>
      <div><label>Name</label><input id="acc_name"></div>
      <div><label>TIN</label><input id="acc_tin"></div>
      <div><label>Gmail</label><input id="acc_gmail"></div>
    </div>
    <div class="row">
      <button id="btn-verify" class="btn">Verify</button>
      <span id="verify-status" class="pill"></span>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="card" id="step2">
    <h2>Step 2 ‚Äî Capture & OCR</h2>
    <div class="row">
      <input id="file-input" type="file" accept="image/*,application/pdf" multiple />
      <button id="btn-preprocess-basic" class="btn">Preprocess (Basic)</button>
      <button id="btn-preprocess-strong" class="btn">Strong Preprocess (Handwriting)</button>
      <button id="btn-preprocess-ultra" class="btn">Ultra Preprocess (Tiny Print + Handwriting)</button>
    </div>
    <div class="row">
      <label class="toggle"><input id="chk-smallprint" type="checkbox" checked /> <span>Boost Small Print</span></label>
      <button id="btn-run-ocr" class="btn primary">Run OCR</button>
      <span id="ocr-status" class="pill">Idle</span>
    </div>

    <!-- Camera controls -->
    <div class="cam-wrap">
      <div class="cam-toolbar">
        <button id="cam-start" class="btn">Start Camera</button>
        <button id="cam-switch" class="btn">Switch Camera</button>
        <button id="cam-capture" class="btn primary">Capture</button>
        <button id="cam-stop" class="btn danger">Stop</button>
        <span id="cam-status" class="pill">Camera idle</span>
      </div>
      <div class="cam-box"><video id="cam" autoplay playsinline muted></video></div>
    </div>

    <label class="toggle">
      <input id="toggle-before-after" type="checkbox">
      <span>Show ‚ÄúBefore‚Äù image</span>
    </label>

    <div id="thumbs" class="thumbs"></div>
  </section>

  <!-- STEP 3 -->
  <section class="card" id="step3">
    <h2>Step 3 ‚Äî Manual Review & Edit</h2>

    <!-- Inline Large Viewer with Overlay -->
    <div id="viewer" class="viewer">
      <div class="viewer-toolbar">
        <button id="v-fit" class="btn xs">Fit</button>
        <button id="v-1x" class="btn xs">1:1</button>
        <button id="v-zoom-out" class="btn xs">‚àí</button>
        <input id="v-zoom-slider" type="range" min="30" max="600" value="100" />
        <button id="v-zoom-in" class="btn xs">+</button>
        <button id="v-rotate" class="btn xs">‚ü≤ Rotate</button>
        <label class="small">Brightness <input id="v-bright" type="range" min="50" max="200" value="100" /></label>
        <label class="small">Contrast <input id="v-contrast" type="range" min="50" max="200" value="100" /></label>

        <label class="toggle" style="margin-left:auto">
          <input id="chk-overlay" type="checkbox" checked />
          <span>Show Overlay (click to jump)</span>
        </label>
        <span class="legend">
          <i class="lg lg-item"></i> Item
          <i class="lg lg-qty"></i> Qty
          <i class="lg lg-price"></i> Unit
          <i class="lg lg-amt"></i> Amount
        </span>
        <button id="btn-clear-overlay" class="btn xs">Clear Overlay</button>
        <span class="muted">Drag to pan ‚Ä¢ Wheel/Pinch to zoom</span>
      </div>

      <div id="viewer-canvas" class="viewer-canvas">
        <img id="v-before" alt="">
        <img id="v-after" alt="">
        <canvas id="v-overlay"></canvas>
      </div>

      <div class="row">
        <button id="btn-apply-ocr" class="btn">Apply OCR ‚Üí Fields</button>
        <button id="btn-parse-table" class="btn">Parse Line Items (Layout)</button>
        <span id="save-status" class="pill"></span>
      </div>
    </div>

    <!-- Form -->
    <div class="grid3">
      <div><label>Receipt Date (YYYY-MM-DD)</label><input id="f_date" placeholder="2025-01-31"></div>
      <div><label>Document Type</label>
        <select id="f_doc_type">
          <option>Sales Invoice</option><option>Official Receipt</option><option>Receipt</option><option>Invoice</option>
        </select>
      </div>
      <div><label>Document Number</label><input id="f_doc_no" placeholder="SI-0001234"></div>

      <div><label>Seller Name</label><input id="f_seller_name"></div>
      <div><label>Seller TIN</label><input id="f_seller_tin"></div>
      <div><label>Seller Address</label><input id="f_seller_addr"></div>
      <div><label>Buyer Name</label><input id="f_buyer_name"></div>
      <div><label>Buyer TIN</label><input id="f_buyer_tin"></div>
      <div><label>Buyer Address</label><input id="f_buyer_addr"></div>

      <div><label>Role</label>
        <select id="f_role"><option>BUYER/PAYOR</option><option>SELLER/ISSUER</option></select>
      </div>
      <div><label>Transaction Type</label>
        <select id="f_txn_type">
          <option>Cash Sales</option><option>Charge Sales</option><option>Collections</option>
          <option>Payment to Suppliers</option><option>Disbursements</option>
          <option>Cash Purchase</option><option>Charge Purchase</option>
        </select>
      </div>
      <div><label>Payment Method</label><input id="f_payment" placeholder="Cash / Transfer / Card / eWallet / Check / Others"></div>

      <div><label>Gross Amount</label><input id="f_gross" type="number" step="0.01"></div>
      <div><label>Vatable Sales</label><input id="f_vatable" type="number" step="0.01"></div>
      <div><label>VAT Amount</label><input id="f_vat" type="number" step="0.01"></div>

      <div><label>Discount</label><input id="f_disc" type="number" step="0.01"></div>
      <div><label>Total Amount Due</label><input id="f_total" type="number" step="0.01"></div>
      <div><label>Withholding Tax (optional)</label><input id="f_wht" type="number" step="0.01"></div>

      <div><label>ID Number</label><input id="f_idno"></div>
      <div class="colspan3"><label>Terms (for on-account)</label><input id="f_terms"></div>
      <div class="colspan3"><label>Notes (exempt/0%/senior/pwd/solo-parent/other)</label><input id="f_notes"></div>
    </div>

    <h3>Line Items</h3>
    <table class="items">
      <thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Unit Price</th><th>Line Amount</th><th></th></tr></thead>
      <tbody id="items-body"></tbody>
    </table>
    <div class="row">
      <button id="btn-add-item" class="btn">Add Row</button>
      <button id="btn-clear-items" class="btn">Clear</button>
    </div>

    <div class="row">
      <button id="btn-save-record" class="btn primary">Save Record</button>
      <span id="export-status" class="pill"></span>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="card" id="step4">
    <h2>Step 4 ‚Äî Export</h2>
    <div class="row">
      <button id="btn-export-csv" class="btn">Export CSV (2 files)</button>
      <button id="btn-export-zip" class="btn">Export ZIP (images+CSV+JSON)</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="card" id="step5">
    <h2>Step 5 ‚Äî Cleanup</h2>
    <div class="row">
      <button id="btn-clear-session" class="btn">Clear Session</button>
      <button id="btn-full-reset" class="btn danger">Full Reset</button>
    </div>
  </section>

  <!-- Self-Test -->
  <section class="card">
    <h2>Self-Test</h2>
    <div class="row"><button id="btn-run-selftest" class="btn">Run Self-Test</button></div>
    <div id="selftest-results" class="list"></div>
  </section>

</main>

<footer class="foot">¬© 2025 Resibo ‚Äî Privacy-first. All processing happens locally.</footer>

<script>
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=3.6.1');
</script>
</body>
</html>
