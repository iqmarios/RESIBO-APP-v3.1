<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resibo App v3.6.1</title>
  <link rel="manifest" href="manifest.json?v=3.6.1">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#0b1220"/>
  <link rel="stylesheet" href="style.css?v=3.6.1"/>
  <!-- libs -->
  <script src="libs/jszip.min.js"></script>
  <script src="libs/FileSaver.min.js"></script>
  <script src="libs/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';</script>
  <script src="libs/tesseract.min.js"></script>
  <script src="libs/opencv.js"></script>
</head>
<body>
  <header class="appbar">
    <div class="brand">Resibo App <span class="ver">v3.6.1</span></div>
    <div class="spacer"></div>
    <button id="btn-run-selftest" class="btn ghost">Self-Test</button>
  </header>

  <main class="container">

    <!-- SETTINGS -->
    <section class="card">
      <h2>Settings</h2>
      <label>Issued Codes CSV URL (HTTPS)</label>
      <div class="row">
        <input id="csvUrl" class="grow" placeholder="https://docs.google.com/.../pub?output=csv">
        <button id="btn-save-settings" class="btn">Save</button>
        <button id="btn-test-csv" class="btn ghost">Test CSV</button>
        <button id="btn-clear-url" class="btn ghost" onclick="localStorage.removeItem('resibo_csv_url');document.getElementById('csvUrl').value='';">No URL</button>
      </div>
      <div id="csv-status" class="pill">Idle</div>
    </section>

    <!-- STEP 1 -->
    <section class="card" id="step1">
      <h2>Step 1 — Access Verification</h2>
      <div class="grid2">
        <div>
          <label>Access Code</label>
          <input id="acc_code" placeholder="RES-TEST-001">
        </div>
        <div>
          <label>Name</label>
          <input id="acc_name" placeholder="Your registered name">
        </div>
        <div>
          <label>TIN</label>
          <input id="acc_tin" placeholder="123-456-789">
        </div>
        <div>
          <label>Gmail</label>
          <input id="acc_gmail" placeholder="you@gmail.com">
        </div>
      </div>
      <div class="row">
        <button id="btn-verify" class="btn">Verify</button>
        <button id="btn-clear-session" class="btn ghost">Clear Session</button>
        <div id="verify-status" class="pill">Idle</div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="card" id="step2">
      <h2>Step 2 — Capture & OCR</h2>

      <input id="file-input" type="file" accept="image/*,application/pdf" multiple class="hidden">
      <div class="row">
        <label for="file-input" class="btn">Choose Files</label>
        <div class="muted">You can upload images/PDF or use the camera below.</div>
      </div>

      <div class="row wrap">
        <button id="btn-preprocess-basic" class="btn ghost">Preprocess (Basic)</button>
        <button id="btn-preprocess-strong" class="btn ghost">Strong Preprocess (Handwriting)</button>
        <button id="btn-preprocess-ultra" class="btn ghost">Ultra Preprocess (Tiny Print + Handwriting)</button>

        <label class="chk">
          <input type="checkbox" id="chk-smallprint" checked>
          <span>Boost Small Print</span>
        </label>

        <button id="btn-run-ocr" class="btn primary">Run OCR</button>
        <div id="ocr-status" class="pill">Idle</div>
      </div>

      <div id="thumbs" class="thumbs"></div>

      <!-- Camera controls -->
      <div class="cam">
        <video id="cam" autoplay playsinline muted></video>
        <div class="row wrap">
          <button id="cam-start" class="btn">Start Camera</button>
          <button id="cam-switch" class="btn ghost">Switch Camera</button>
          <button id="cam-capture" class="btn">Capture</button>
          <button id="cam-stop" class="btn danger">Stop</button>
          <div id="cam-status" class="pill">Camera idle</div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="card" id="step3">
      <h2>Step 3 — Manual Review & Edit</h2>

      <!-- Viewer with overlay -->
      <div id="viewer-canvas" class="viewer">
        <img id="v-before" class="viewer-img" alt="">
        <img id="v-after" class="viewer-img" alt="">
        <canvas id="v-overlay"></canvas>
      </div>
      <div class="row wrap">
        <button id="v-zoom-out" class="btn ghost">−</button>
        <input id="v-zoom-slider" type="range" min="30" max="600" value="100">
        <button id="v-zoom-in" class="btn ghost">+</button>
        <button id="v-1x" class="btn ghost">1×</button>
        <button id="v-fit" class="btn ghost">Fit</button>
        <button id="v-rotate" class="btn ghost">Rotate</button>

        <label class="slider">Brightness <input id="v-bright" type="range" min="50" max="200" value="100"></label>
        <label class="slider">Contrast <input id="v-contrast" type="range" min="50" max="200" value="100"></label>

        <label class="chk"><input type="checkbox" id="chk-overlay" checked><span>Show Overlay</span></label>
        <button id="btn-clear-overlay" class="btn ghost">Clear Overlay</button>
      </div>

      <!-- Form (key fields only for brevity; extend as needed) -->
      <div class="grid3">
        <div><label>Receipt Date</label><input id="f_date" placeholder="YYYY-MM-DD"></div>
        <div><label>Document Type</label>
          <select id="f_doc_type">
            <option value="">—</option>
            <option>Official Receipt</option>
            <option>Sales Invoice</option>
            <option>Receipt</option>
          </select>
        </div>
        <div><label>Document Number</label><input id="f_doc_no"></div>

        <div><label>Seller Name</label><input id="f_seller_name"></div>
        <div><label>Seller TIN</label><input id="f_seller_tin"></div>
        <div><label>Seller Address</label><input id="f_seller_addr"></div>

        <div><label>Buyer Name</label><input id="f_buyer_name"></div>
        <div><label>Buyer TIN</label><input id="f_buyer_tin"></div>
        <div><label>Buyer Address</label><input id="f_buyer_addr"></div>

        <div><label>Gross Amount</label><input id="f_gross" type="number" step="0.01"></div>
        <div><label>Vatable Sales</label><input id="f_vatable" type="number" step="0.01"></div>
        <div><label>VAT Amount</label><input id="f_vat" type="number" step="0.01"></div>

        <div><label>Discount</label><input id="f_disc" type="number" step="0.01"></div>
        <div><label>Total Amount Due</label><input id="f_total" type="number" step="0.01"></div>
        <div><label>Payment Method</label><input id="f_payment"></div>

        <div><label>Role (auto)</label>
          <select id="f_role">
            <option>BUYER/PAYOR</option>
            <option>SELLER/ISSUER</option>
          </select>
        </div>
        <div><label>Transaction Type</label>
          <select id="f_txn_type">
            <option value="">— Select —</option>
            <option>Cash Sales</option><option>Charge Sales</option><option>Collections</option>
            <option>Payment to Suppliers</option><option>Disbursements</option>
            <option>Cash Purchase</option><option>Charge Purchase</option>
          </select>
        </div>
        <div><label>Terms (for on-account)</label><input id="f_terms"></div>

        <div><label>Notes</label><input id="f_notes"></div>
        <div><label>ID Number</label><input id="f_idno"></div>
        <div><label>Withholding Tax</label><input id="f_wht" type="number" step="0.01"></div>
      </div>

      <div class="row">
        <button id="btn-apply-ocr" class="btn">Apply OCR → Fields</button>
        <button id="btn-parse-table" class="btn ghost">Parse Line Items (Layout)</button>
        <div id="save-status" class="pill">Idle</div>
      </div>

      <h3>Line Items</h3>
      <table class="items">
        <thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Unit Price</th><th>Amount</th><th></th></tr></thead>
        <tbody id="items-body"></tbody>
      </table>
      <div class="row">
        <button id="btn-add-item" class="btn ghost">+ Add row</button>
        <button id="btn-clear-items" class="btn ghost">Clear</button>
      </div>
    </section>

    <!-- STEP 4/5 -->
    <section class="card">
      <h2>Step 4 — Export</h2>
      <div class="row">
        <button id="btn-save-record" class="btn">Save (Local)</button>
        <button id="btn-export-csv" class="btn ghost">Export CSV</button>
        <button id="btn-export-zip" class="btn ghost">Export ZIP</button>
        <div id="export-status" class="pill">Idle</div>
      </div>
    </section>

    <section class="card">
      <h2>Step 5 — Self-Test</h2>
      <div id="selftest-results" class="selftest"></div>
    </section>

    <div class="floating">
      <button id="btn-top" class="fab">Top</button>
      <button id="btn-jump-step3" class="fab">↓ Review</button>
    </div>

  </main>

  <script src="app.js?v=3.6.1a"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=3.6.1').then(reg => {
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          if (!nw) return;
          nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
              navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
            }
          });
        });
      });
    }
  </script>
</body>
</html>
